# Math Helper 작업일지 - 2025-12-22

## 📋 작업 개요

**시작 시점**: v1.0.0 배포 완료 상태
**종료 시점**: v1.0.5-DEBUG 빌드 완료
**주요 이슈**: "시스템 오류: 수학 엔진을 로드할 수 없습니다" 에러 해결 시도

---

## 🔍 문제 발견 및 진단 과정

### Phase 1: 초기 문제 (v1.0.0)
**증상**:
- Windows .exe 실행 시 "시스템 오류: 수학 엔진을 로드할 수 없습니다" 에러
- 모든 계산 기능 작동 불가
- 사용자 제공 스크린샷: 시스템 오류 메시지

**초기 가설**:
- node_modules가 빌드에 포함되지 않음
- mathjs/nerdamer 패키지 누락

**조치**:
- `package.json` build.files에 `"node_modules/**/*"` 추가
- v1.0.1 빌드 생성

**결과**: ❌ 여전히 동일한 에러

---

### Phase 2: 디버깅 강화 (v1.0.2-DEBUG)
**접근**:
- preload.js에 상세한 에러 핸들링 및 로깅 추가
- try-catch로 각 단계별 로딩 상태 확인
- UniversalCalculator.tsx에 mathAPI 체크 로직 강화
- main.js에서 프로덕션 DevTools 자동 열기

**핵심 발견**:
```
[Preload] Starting math engine initialization...
[Preload] Electron contextBridge loaded
❌ [Preload] Math engine initialization FAILED: Error: module not found: mathjs
```

**원인 파악**:
- Electron의 **sandbox 모드**가 preload.js에서 `require('mathjs')` 호출을 차단
- node_modules는 포함되었지만 sandbox 보안 정책으로 접근 불가

---

### Phase 3: Sandbox 비활성화 (v1.0.3)
**수정 사항**:
```javascript
// main.js:12
webPreferences: {
  nodeIntegration: false,      // 보안 유지
  contextIsolation: true,      // 보안 유지
  sandbox: false,              // ✅ 핵심 수정
  preload: path.join(__dirname, 'preload.js')
}
```

**기대 효과**:
- preload.js가 node_modules 접근 가능
- mathjs/nerdamer 정상 로딩

**테스트 시도**:
- Linux Wine 테스트: 실패 (wine: could not load kernel32.dll)
- Windows 실제 테스트 필요

**결과**: ⏳ 검증 미완료 (Wine 불가)

---

### Phase 4: 실제 Windows 테스트 (v1.0.3~4)
**사용자 피드백**:
1. 스크린샷 1: `2+3xsin(pi/2)=` 입력
   - 에러: "Invalid left hand side of assignment operator = (char 14)"

2. 스크린샷 2: `2+3xsin(pi/2)` 입력
   - 에러: "Undefined function xsin"

3. 스크린샷 3: `2x + 3 =` 입력
   - 에러: "Invalid left hand side of assignment operator = (char 8)"

4. 스크린샷 4: `2x+3=7` 입력 (방정식 모드)
   - 에러: "Invalid left hand side of assignment operator = (char 5)"
   - **중요**: 모드는 "방정식"이지만 입력 예시는 "2 + 3 * sin(pi/2)" (계산 모드)

**핵심 발견**:
- 에러가 **mathjs에서 발생** → 수학 엔진은 로드됨!
- 문제는 엔진 로딩이 아니라 **UI 모드 전환 버그**

**재평가**:
- sandbox 수정은 성공 (mathjs 작동 중)
- 실제 문제: React 컴포넌트의 모드 상태 업데이트 실패

---

## 🔧 최종 해결 방향 (v1.0.5-DEBUG)

### 진단용 기능 추가

**1. 명시적 모드 표시**:
```tsx
// UniversalCalculator.tsx:256-258
<span className="ml-2 text-xs font-bold text-blue-600">
  [현재 모드: {currentMode.label}]
</span>
```
- 화면에서 현재 모드를 즉시 확인 가능
- 모드 전환 여부를 시각적으로 검증

**2. 콘솔 로깅**:
```tsx
// UniversalCalculator.tsx:235
onClick={() => {
  console.log('[MODE] 모드 변경:', mode, '→', m.id, m.label)
  setMode(m.id)
  // ...
}}
```
- 모드 버튼 클릭 시 콘솔 출력
- React 상태 업데이트 호출 여부 확인

**3. 추가 보안 설정**:
```javascript
// main.js:13-15
enableRemoteModule: false,
nodeIntegrationInWorker: false,
nodeIntegrationInSubFrames: false,
```

---

## 📊 빌드 히스토리

| 버전 | 주요 변경 | 결과 |
|------|----------|------|
| v1.0.0 | 초기 배포 | ❌ 수학 엔진 로드 실패 |
| v1.0.1 | node_modules 빌드 포함 | ❌ 여전히 실패 |
| v1.0.2-DEBUG | 상세 로깅 추가 | ✅ 원인 파악 (sandbox) |
| v1.0.3 | sandbox: false | ⏳ Wine 불가 |
| v1.0.4 | 캐시 클리어 재빌드 | ⏳ 검증 필요 |
| v1.0.5-DEBUG | 모드 전환 디버깅 | 📦 현재 버전 |

---

## 🎯 다음 작업 (내일)

### 1단계: 진단 확인
- [ ] v1.0.5-DEBUG Windows 실행
- [ ] 방정식 버튼 클릭
- [ ] "[현재 모드: ???]" 확인
- [ ] 콘솔 "[MODE]" 메시지 확인

### 2단계: 분기 대응

**Case A: 모드 표시가 바뀌지 않음**
- React 상태 업데이트 실패
- 원인: 빌드 과정에서 React 코드 문제
- 해결: 상태 관리 방식 재검토

**Case B: 모드 표시는 바뀌지만 계산 실패**
- 상태는 업데이트되지만 handleCalculate에서 올바른 API 호출 안 함
- 원인: switch-case 로직 또는 window.mathAPI 메서드 문제
- 해결: handleCalculate 로직 검증

**Case C: 모드 표시 바뀌고 계산 성공**
- 모든 것이 정상 작동
- 이전 테스트 시 잘못된 입력 형식 사용 (곱셈 기호 누락 등)
- 해결: DevTools 제거 후 v1.1.0 최종 배포

---

## 🔄 Git 커밋 내역

```
562c53b - fix: Electron sandbox 비활성화로 수학 엔진 로딩 문제 해결 (v1.0.3)
0317352 - debug: 모드 전환 버그 진단을 위한 디버깅 기능 추가 (v1.0.5-DEBUG)
```

**GitHub**: https://github.com/ljchg12-hue/math-helper
**브랜치**: master
**최신 푸시**: 2025-12-22 01:35

---

## 📦 빌드 산출물

### 위치
```
/mnt/4tb/1.work/release/
├── MathHelper-v1.0.3/          # sandbox 수정
├── MathHelper-v1.0.4/          # 캐시 클리어 재빌드
└── MathHelper-v1.0.5-DEBUG/    # 모드 전환 진단 (최종)
```

### v1.0.5-DEBUG 구성
- MathHelper.exe (169MB)
- resources/app.asar (290MB)
- 디버그안내.txt
- 기타 Electron 런타임 파일

---

## 💡 교훈

### 기술적 발견
1. **Electron sandbox 모드**: preload에서 node_modules 접근 차단
2. **에러 메시지 분석**: mathjs 에러 = 엔진 작동 중
3. **빌드 검증의 중요성**: Wine 불가 환경에서 실제 테스트 필수
4. **점진적 디버깅**: 각 단계마다 로깅 추가로 원인 특정

### 프로세스 개선
1. **명시적 상태 표시**: UI에서 내부 상태 가시화 중요
2. **테스트 환경**: Linux 개발 → Windows 배포 시 검증 전략 필요
3. **커뮤니케이션**: 사용자 피드백 (스크린샷) 적극 활용

---

## 📝 메모

**작업 시간**: 약 2시간
**주요 도구**: Electron Builder, Vite, Git
**주요 과제**: Cross-platform 빌드 검증
**미해결 이슈**: 모드 전환 실제 작동 여부 (Windows 테스트 필요)

---

**작성**: Claude Code (2025-12-22)
**다음 작업일**: 2025-12-23 (예정)
